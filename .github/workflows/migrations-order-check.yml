name: Проверка порядка миграций

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Получить код репозитория
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Определить, есть ли новые SQL-миграции
        id: mig
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          git fetch origin "$BASE_SHA" --depth=1

          run="$(git diff --name-status "$BASE_SHA..$HEAD_SHA" | python3 - <<'PY'
import sys

BAD = "\u200e\u200f\ufeff\u200b"  # частые невидимые символы в конце

for line in sys.stdin:
    parts = line.rstrip("\n").split("\t")
    if len(parts) < 2:
        continue
    status = parts[0]
    path = parts[1].rstrip(BAD)

    if status == "A" and path.startswith("migrations/") and path.endswith(".sql"):
        print("true")
        raise SystemExit(0)

print("false")
PY
)"
          echo "run=$run" >> "$GITHUB_OUTPUT"

      - name: Пропуск (если новых SQL-миграций нет)
        if: steps.mig.outputs.run != 'true'
        run: echo "Новых SQL-миграций нет — проверка не требуется."

      - name: Проверить формат имён новых миграций
        if: steps.mig.outputs.run == 'true'
        shell: bash
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          git fetch origin "$BASE_SHA" --depth=1

          python3 - <<'PY'
import os
import re
import subprocess
import sys

BASE_SHA = os.environ["BASE_SHA"]
HEAD_SHA = os.environ["HEAD_SHA"]

BAD = "\u200e\u200f\ufeff\u200b"

# Новый строгий формат (18 цифр до "_"):
# <YY><Major(месяц 01-12)><Minor(2)><Hotfix(2)><MM(01-12)><DD><HH><mm><ss>_desc.sql
strict_name_regex = re.compile(
    r"^(?P<yy>\d{2})"
    r"(?P<major>(0[1-9]|1[0-2]))"
    r"(?P<minor>\d{2})"
    r"(?P<hf>\d{2})"
    r"(?P<MM>(0[1-9]|1[0-2]))"
    r"(?P<DD>(0[1-9]|[12]\d|3[01]))"
    r"(?P<HH>([01]\d|2[0-3]))"
    r"(?P<mm>([0-5]\d))"
    r"(
